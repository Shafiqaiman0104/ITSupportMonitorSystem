<!DOCTYPE html>
<html>
<head>
  <title>IT Support HITL Panel</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      background: #f3f4f6;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 15px;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
    }

    .sidebar h3 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: bold;
      color: #374151;
    }

    .search-box {
      position: sticky;
      top: 0;
      background: white;
      padding-bottom: 10px;
      margin-bottom: 10px;
      z-index: 5;
    }

    .search-box input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 30px 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      outline: none;
    }

    .search-box::after {
      content: 'üîç';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
    }

    #sessionList {
      margin: 0;
      padding: 0;
      flex: 1;
      overflow-y: auto;
    }

    #sessionList li {
      list-style: none;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #sessionList li:hover {
      background: #f3f4f6;
    }

    #sessionList li.active {
      background: #3b82f6;
      color: white;
    }

    /* Chat Section */
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .controls span {
      font-weight: 600;
      font-size: 14px;
    }

    /* Toggle Button */
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 28px;
    }

    .toggle-switch input {
      display: none;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #3b82f6;
    }

    input:checked + .slider:before {
      transform: translateX(32px);
    }

    /* Messages */
    .messages {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
    }

    .msg {
      max-width: 70%;
      padding: 8px 12px;
      margin-bottom: 20px;
      border-radius: 8px;
      position: relative;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      word-wrap: break-word;
    }

    /* Message types alignment */
    .bot-msg {
      background: #e0f2fe;
      align-self: flex-end; /* right */
    }

    .user-msg {
      background: #dcfce7;
      align-self: flex-start; /* left */
    }

    .agent-msg {
      background: #fef9c3;
      align-self: flex-end; /* right */
    }

    /* Input Box */
    .input-box {
      display: flex;
      padding: 10px;
      background: white;
      border-top: 1px solid #e5e7eb;
      gap: 6px;
    }

    .input-box input {
      flex: 1;
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      outline: none;
    }

    .input-box button {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .input-box button:hover {
      background: #2563eb;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h3>Sessions</h3>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search by User ID" oninput="filterSessions()">
  </div>
  <ul id="sessionList"></ul>
</div>

<div class="chat">
  <div class="controls">
    <span id="sessionLabel">No Session Selected</span>
    <label class="toggle-switch">
      <input type="checkbox" id="pauseToggle" onchange="togglePause()">
      <span class="slider"></span>
    </label>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-box">
    <input type="text" id="msgInput" placeholder="Type your message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const BOT_ID = "mk-ai-chatbot";
const API_BASE = "https://venturerush.up.railway.app/api/v1";
let TOKEN = null;
let currentSession = null;
let paused = false;
let allSessions = []; 

const ADMIN_EMAIL = "venturerush.cs@gmail.com";
const ADMIN_PASSWORD = "venturerush123";

async function loginAndGetToken() {
  const res = await fetch(`${API_BASE}/auth/login/basic/default`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: ADMIN_EMAIL, password: ADMIN_PASSWORD })
  });
  const data = await res.json();
  TOKEN = data.payload && data.payload.jwt;
  if (!TOKEN) {
    alert("Failed to get token. Check credentials.");
    return;
  }
  loadSessions();
}

async function loadSessions() {
  const res = await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions`, {
    headers: { "Authorization": `Bearer ${TOKEN}` }
  });
  allSessions = await res.json();
  renderSessionList(allSessions);
}

async function filterSessions() {
  const searchTerm = document.getElementById("searchInput").value.trim();
  const url = `${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions?pausedOnly=false&searchText=${encodeURIComponent(searchTerm)}`;
  const res = await fetch(url, {
    headers: { "Authorization": `Bearer ${TOKEN}` }
  });
  const filtered = await res.json();
  renderSessionList(filtered);
}

function renderSessionList(sessions) {
  const list = document.getElementById("sessionList");
  list.innerHTML = "";
  sessions.forEach(s => {
    const li = document.createElement("li");
    li.textContent = `Session ${String(s.id)}`;
    if (currentSession === s.id) li.classList.add("active");
    li.onclick = () => { 
      currentSession = s.id; 
      paused = false; 
      document.getElementById("pauseToggle").checked = false;
      document.getElementById("sessionLabel").textContent = `Session ${String(currentSession)}`;
      renderSessionList(sessions);
      loadSessionData(); 
    };
    list.appendChild(li);
  });
}

async function loadSessionData() {
  if (!currentSession) return;
  const res = await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}`, {
    headers: { "Authorization": `Bearer ${TOKEN}` }
  });
  const messages = await res.json();
  const chatBox = document.getElementById("messages");
  chatBox.innerHTML = "";

  if (Array.isArray(messages) && messages.length > 0) {
    messages.forEach(m => {
      const text = m.text || m.raw_message?.text || "[empty]";
      const div = document.createElement("div");

      if (m.source === "bot") div.className = "msg bot-msg";
      else if (m.source === "agent") div.className = "msg agent-msg";
      else div.className = "msg user-msg";

      div.textContent = `${m.source}: ${text}`;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  } else {
    chatBox.innerHTML = "<i>No messages found</i>";
  }
}

async function sendMessage(customMsg) {
  const msg = customMsg || document.getElementById("msgInput").value;
  if (!currentSession || !msg) return;
  await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}/message`, {
    method: "POST",
    headers: { 
      "Authorization": `Bearer ${TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ message: msg })
  });
  if (!customMsg) document.getElementById("msgInput").value = "";
  loadSessionData();
}

async function togglePause() {
  if (!currentSession) return;
  if (!paused) {
    await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}/pause`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${TOKEN}` }
    });
    await sendMessage(`-Agent has taken over this conversation`);
    paused = true;
    document.getElementById("sessionLabel").textContent = `Session ${String(currentSession)} (Paused)`;
  } else {
    await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}/unpause`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${TOKEN}` }
    });
    await sendMessage(`-Agent has left the chat, chatbot is back in action`);
    paused = false;
    document.getElementById("sessionLabel").textContent = `Session ${String(currentSession)}`;
  }
}

setInterval(() => { if (currentSession) loadSessionData(); }, 3000);

loginAndGetToken();
</script>

</body>
</html>
