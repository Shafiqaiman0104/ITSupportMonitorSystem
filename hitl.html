<!DOCTYPE html>
<html>
<head>
  <title>IT Support HITL Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    .sidebar {
      width: 200px;
      border-right: 1px solid #ccc;
      padding: 10px;
      background: #fff;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow-y: auto;
    }
    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      border-bottom: 1px solid #ccc;
      padding: 10px;
      background: #f9f9f9;
    }
    .input-box {
      display: flex;
      gap: 5px;
      padding: 10px;
      border-top: 1px solid #ccc;
      background: #fff;
    }
    .input-box input {
      flex: 1;
      padding: 5px;
    }
    li {
      list-style: none;
      padding: 5px;
      cursor: pointer;
    }
    li:hover {
      background: #eee;
    }
    .bot-msg {
      background: #e1f5fe;
      padding: 5px;
      margin: 2px 0;
      border-radius: 5px;
    }
    .user-msg {
      background: #c8e6c9;
      padding: 5px;
      margin: 2px 0;
      border-radius: 5px;
    }
    .controls {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      background: #fafafa;
      display: flex;
      gap: 10px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .controls span {
      font-weight: bold;
    }
    .controls button {
      padding: 5px 10px;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h3>Sessions</h3>
  <ul id="sessionList"></ul>
</div>

<div class="chat">
  <div class="controls">
    <span id="sessionLabel">No Session Selected</span>
    <button id="pauseBtn" onclick="togglePause()" disabled>Pause Bot</button>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-box">
    <input type="text" id="msgInput" placeholder="Type your message">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const BOT_ID = "mk-ai-chatbot";
const API_BASE = "https://venturerush.up.railway.app/api/v1";
let TOKEN = null;
let currentSession = null;
let paused = false;
const agentName = "Shafiq"; // 📝 Change this to your dynamic agent name

const ADMIN_EMAIL = "venturerush.cs@gmail.com";
const ADMIN_PASSWORD = "venturerush123";

// Login and get token
async function loginAndGetToken() {
  const res = await fetch(`${API_BASE}/auth/login/basic/default`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: ADMIN_EMAIL,
      password: ADMIN_PASSWORD
    })
  });
  const data = await res.json();
  TOKEN = data.payload && data.payload.jwt;
  if (!TOKEN) {
    alert("Failed to get token. Check credentials.");
    return;
  }
  console.log("New token:", TOKEN);
  loadSessions();
}

async function loadSessions() {
  const res = await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions`, {
    headers: { "Authorization": `Bearer ${TOKEN}` }
  });
  const sessions = await res.json();
  const list = document.getElementById("sessionList");
  list.innerHTML = "";
  sessions.forEach(s => {
    const li = document.createElement("li");
    li.textContent = `Session ${s.id}`;
    li.onclick = () => { 
      currentSession = s.id; 
      paused = false; 
      document.getElementById("pauseBtn").textContent = "Pause Bot";
      document.getElementById("pauseBtn").disabled = false;
      document.getElementById("sessionLabel").textContent = `Session ${currentSession}`;
      loadSessionData(); 
    };
    list.appendChild(li);
  });
}

async function loadSessionData() {
  if (!currentSession) return;
  const res = await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}`, {
    headers: { "Authorization": `Bearer ${TOKEN}` }
  });
  const messages = await res.json();
  const chatBox = document.getElementById("messages");
  chatBox.innerHTML = "";

  if (Array.isArray(messages) && messages.length > 0) {
    messages.forEach(m => {
      const text = m.text || m.raw_message?.text || "[empty]";
      const div = document.createElement("div");
      div.className = m.source === "bot" ? "bot-msg" : "user-msg";
      div.textContent = `${m.source}: ${text}`;
      chatBox.appendChild(div);
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  } else {
    chatBox.innerHTML = "<i>No messages found</i>";
  }
}

async function sendMessage(customMsg) {
  const msg = customMsg || document.getElementById("msgInput").value;
  if (!currentSession || !msg) return;
  await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}/message`, {
    method: "POST",
    headers: { 
      "Authorization": `Bearer ${TOKEN}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ message: msg })
  });
  if (!customMsg) {
    document.getElementById("msgInput").value = "";
  }
  loadSessionData();
}

// Pause/Resume bot with notification
async function togglePause() {
  if (!currentSession) return;
  if (!paused) {
    await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}/pause`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${TOKEN}` }
    });
    await sendMessage(`-Agent ${agentName} has taken over this conversation`);
    paused = true;
    document.getElementById("pauseBtn").textContent = "Resume Bot";
    document.getElementById("sessionLabel").textContent = `Session ${currentSession} (Paused)`;
  } else {
    await fetch(`${API_BASE}/bots/${BOT_ID}/mod/hitl/sessions/${currentSession}/unpause`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${TOKEN}` }
    });
    await sendMessage(`-Agent ${agentName} has left the chat, chatbot is back in action`);
    paused = false;
    document.getElementById("pauseBtn").textContent = "Pause Bot";
    document.getElementById("sessionLabel").textContent = `Session ${currentSession}`;
  }
}

// Auto-refresh messages
setInterval(() => {
  if (currentSession) loadSessionData();
}, 3000);

loginAndGetToken();
</script>

</body>
</html>
