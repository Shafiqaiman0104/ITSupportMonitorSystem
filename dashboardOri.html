<!DOCTYPE html>
<html>
<head>
  <title>VentureRush Support - Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, sans-serif; 
      margin: 0; 
      background: #f4f6f8;
      color: #333;
    }
    .navbar {
      background: #007bff;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .navbar .logo {
      font-size: 18px;
      font-weight: bold;
    }
    .navbar ul {
      list-style: none;
      display: flex;
      gap: 15px;
      margin: 0;
      padding: 0;
    }
    .navbar ul li a {
      color: white;
      text-decoration: none;
      padding: 6px 10px;
      border-radius: 4px;
      transition: background 0.2s ease;
    }
    .navbar ul li a:hover {
      background: rgba(255,255,255,0.2);
    }
    .container {
      width: 85%;
      max-width: 800px;
      margin: 20px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 15px;
    }
    .cards {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin: 20px auto;
      width: 85%;
      max-width: 800px;
    }
    .card {
      flex: 1;
      min-width: 150px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .card h2 {
      margin: 0;
      font-size: 24px;
      color: #007bff;
    }
    .card p {
      margin: 5px 0 0;
      color: #666;
      font-size: 14px;
    }
    h1 { 
      text-align: center; 
      margin-bottom: 15px;
      font-size: 20px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="logo">üßëüèª‚Äçüíª VentureRush Support</div>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="hitlTab.html">HITL</a></li>
      <li><a href="#">Reports</a></li>
    </ul>
  </nav>

  <!-- Stats Cards -->
  <div class="cards">
    <div class="card">
      <h2 id="totalErrors">0</h2>
      <p>Total Errors</p>
    </div>
    <div class="card">
      <h2 id="avgPerformance">0%</h2>
      <p>Avg Performance (This Month)</p>
    </div>
    <div class="card">
      <h2 id="last7DaysPerf">0%</h2>
      <p>Avg Performance (Last 7 Days)</p>
    </div>
  </div>

  <div class="container">
    <h1>üìä Monthly Errors</h1>
    <canvas id="errorChart"></canvas>
  </div>

  <div class="container">
    <h1>‚ö° Monthly Average Performance</h1>
    <canvas id="performanceChart"></canvas>
  </div>

  <div class="container">
    <h1>üìà Last 7 Days Performance</h1>
    <canvas id="last7DaysChart"></canvas>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbxqbrfz2owYrB3vaHJnXRmdyO6xYWA5YbRYTrjQEsUAm04FOkUeQrUM6PsNeGQtbLcs/exec";
    
    async function fetchData() {
      const res = await fetch(scriptUrl);
      const data = await res.json();

      const monthCounts = {};
      const monthPerformance = {};
      const monthKeys = {}; 
      const last7Days = {};

      let totalErrors = 0;
      let thisMonthPerfSum = 0, thisMonthPerfCount = 0;

      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 6);

      data.forEach(row => {
        if (!row["Timestamp"]) return;
        const date = new Date(row["Timestamp"]);
        if (isNaN(date)) return;

        const monthYear = date.toLocaleString("en-GB", { month: "long", year: "numeric", timeZone: "Asia/Kuala_Lumpur" });
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthKeys[monthYear] = monthKey;

        // Count errors
        monthCounts[monthYear] = (monthCounts[monthYear] || 0) + 1;
        totalErrors++;

        // Performance calculation
        if (row["Alert Status"] && row["Alert Status"].startsWith("solve")) {
          const solveString = row["Alert Status"].replace(/^solve\s+/i, "").trim();
          const solveDate = new Date(solveString);
          if (!isNaN(solveDate)) {
            const diffHours = Math.abs(solveDate - date) / (1000 * 60 * 60);
            let performance = Math.max(0, 100 - diffHours * 10);

            // Monthly performance
            if (!monthPerformance[monthYear]) monthPerformance[monthYear] = [];
            monthPerformance[monthYear].push(performance);

            // This month stats
            if (date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear()) {
              thisMonthPerfSum += performance;
              thisMonthPerfCount++;
            }

            // Last 7 days
            if (date >= sevenDaysAgo && date <= today) {
              const dayLabel = date.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
              if (!last7Days[dayLabel]) last7Days[dayLabel] = [];
              last7Days[dayLabel].push(performance);
            }
          }
        }
      });

      // Prepare monthly charts
      const labels = Object.keys(monthCounts).sort((a, b) => monthKeys[a].localeCompare(monthKeys[b]));
      const counts = labels.map(m => monthCounts[m]);
      const avgPerformance = labels.map(m => {
        if (!monthPerformance[m] || monthPerformance[m].length === 0) return 0;
        const sum = monthPerformance[m].reduce((a, b) => a + b, 0);
        return (sum / monthPerformance[m].length).toFixed(1);
      });

      // Prepare last 7 days chart
      const last7Labels = Object.keys(last7Days);
      const last7Perf = last7Labels.map(d => {
        const arr = last7Days[d];
        return arr.reduce((a,b) => a+b, 0) / arr.length;
      });

      // Update cards
      document.getElementById("totalErrors").textContent = totalErrors;
      document.getElementById("avgPerformance").textContent = 
        thisMonthPerfCount ? (thisMonthPerfSum / thisMonthPerfCount).toFixed(1) + "%" : "0%";
      const avg7 = last7Perf.length ? (last7Perf.reduce((a,b)=>a+b,0)/last7Perf.length).toFixed(1) : 0;
      document.getElementById("last7DaysPerf").textContent = avg7 + "%";

      renderErrorChart(labels, counts);
      renderPerformanceChart(labels, avgPerformance);
      renderLast7DaysChart(last7Labels, last7Perf);
    }

    function renderErrorChart(labels, counts) {
      new Chart(document.getElementById('errorChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Number of Errors',
            data: counts,
            backgroundColor: '#007bff',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    }

    function renderPerformanceChart(labels, performance) {
      new Chart(document.getElementById('performanceChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Average Performance (%)',
            data: performance,
            borderColor: '#28a745',
            backgroundColor: '#28a745',
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { callbacks: { label: ctx => ctx.parsed.y + '%' } } },
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
      });
    }

    function renderLast7DaysChart(labels, performance) {
      new Chart(document.getElementById('last7DaysChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Performance (%)',
            data: performance,
            borderColor: '#ff9800',
            backgroundColor: '#ff9800',
            tension: 0.4, // smooth curve
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + '%' } } },
          scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
        }
      });
    }

    fetchData();
  </script>
</body>
</html>

